---
- hosts: leafs,spines
  become: yes
  vars_files:
    - vars.yml
  tasks:
    # - debug:
    #     #var: l3_interfaces.loopback.{{ansible_hostname}}
    #     msg: "{{item}}"
    #   with_items: "{{l3_interfaces.loopback}}"

    # - name: Ping Test
    #   command: ping {{l3_interfaces.loopback[item].ipv4}} -I {{l3_interfaces.loopback[ansible_hostname].ipv4}} -c 1
    #   with_items: "{{l3_interfaces.loopback}}"
    #   # This with_items will provide a list of hostnames

    - name: Get BGP Info
      command: vtysh -c 'show ip bgp sum json'
      register: result

    - set_fact: configured_bgp_peers="{{ result.stdout | from_json }}"

    # - name: blah
    #   debug: msg="{{myvar}}"

    - fail:
        msg: "BGP peers don't match"
      when: not "{{item}}" in {{configured_bgp_peers.peers}}
      with_items: "{{bgp[ansible_hostname].peers}}"
